<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Альтанка в City Lake</title>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL     = "{{ supabase_url }}";
    const SUPABASE_ANON_KEY= "{{ supabase_anon }}";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.supabase = supabase;

    window.addEventListener('DOMContentLoaded', async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        document.getElementById('auth').style.display='none';
        document.getElementById('app').style.display='block';
        initCalendar(session.access_token);
      }
    });
  </script>

  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <style>
    body { font-family: Arial; margin:20px; }
    #app { display:none; }
    #calendar { max-width:600px; margin:0 auto; }
  </style>
</head>
<body>

  <div id="auth">
    <h2>Увійдіть або зареєструйтесь</h2>
    <input id="email" type="email" placeholder="Email"><br>
    <input id="password" type="password" placeholder="Пароль"><br>
    <button id="btn-signup">Зареєструватися</button>
    <button id="btn-signin">Увійти</button>
  </div>

  <div id="app">
    <h1>Альтанка в City Lake</h1>
    <button id="btn-signout">Вийти</button>
    <div id="calendar"></div>
    <!-- форма бронювання і кнопки тут -->
  </div>

  <script type="module">
    const { auth } = window.supabase;
    const btnUp = document.getElementById('btn-signup'),
          btnIn = document.getElementById('btn-signin'),
          btnOut= document.getElementById('btn-signout');

    btnUp.onclick = async () => {
      const email= document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      const { error } = await auth.signUp({ email, password: pass });
      error ? alert(error.message) : alert('Перевірте пошту для підтвердження');
    };

    btnIn.onclick = async () => {
      const email= document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      const { data, error } = await auth.signInWithPassword({ email, password: pass });
      if (error) return alert(error.message);
      document.getElementById('auth').style.display='none';
      document.getElementById('app').style.display='block';
      initCalendar(data.session.access_token);
    };

    btnOut.onclick = async () => {
      await auth.signOut();
      document.getElementById('app').style.display='none';
      document.getElementById('auth').style.display='block';
    };

    function initCalendar(token) {
      axios.defaults.headers.common['Authorization'] = 'Bearer '+token;
      const calendarEl = document.getElementById('calendar');
      new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        events: (_, cb) => axios.get('/api/bookings').then(r => cb(r.data)),
        // dateClick, eventClick тощо
      }).render();
    }
  </script>

</body>
</html>
