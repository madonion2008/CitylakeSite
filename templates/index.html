<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Альтанка в City Lake</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #controls { margin-bottom: 15px; }
    #calendar { max-width: 600px; margin: 0 auto; }
    #form, #bookingsContainer { display: none; margin-top: 20px; }
    label { display: block; margin: 5px 0; }
    select, input, button { padding: 8px; margin-top: 5px; width: 100%; box-sizing: border-box; }
    button { cursor: pointer; margin-right: 10px; }
    #selectedDateDisplay { font-weight: bold; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>Альтанка в City Lake</h1>
  <div id="controls">
    <button id="viewBookingsBtn">Переглянути бронювання</button>
  </div>
  <div id="calendar"></div>
  <div id="form">
    <h3>Бронювання</h3>
    <div id="selectedDateDisplay">Дата: <span id="displayDate"></span></div>
    <form id="bookingForm">
      <input type="hidden" id="bdate" name="date">
      <label>Час початку:
        <select id="btime_start" name="time_start" required></select>
      </label>
      <label>Час кінця:
        <select id="btime_end" name="time_end" required></select>
      </label>
      <label>Ім'я:<input type="text" id="bname" name="name" required></label>
      <label>Телефон / Telegram ID:<input type="text" id="bcontact" name="contact" required></label>
      <button type="submit">Забронювати</button>
      <button type="button" id="cancelBtn">Відмінити</button>
    </form>
  </div>
  <div id="bookingsContainer"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Генерація списку часу з кроком 15 хвилин
      function generateTimeOptions(selectEl) {
        const pad = n => n.toString().padStart(2,'0');
        for (let h = 0; h < 24; h++) {
          for (let m = 0; m < 60; m += 15) {
            const timeStr = `${pad(h)}:${pad(m)}`;
            const option = document.createElement('option');
            option.value = timeStr;
            option.textContent = timeStr;
            selectEl.appendChild(option);
          }
        }
      }
      generateTimeOptions(document.getElementById('btime_start'));
      generateTimeOptions(document.getElementById('btime_end'));

      var calendarEl = document.getElementById('calendar');
      var selectedDate;
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        dateClick: function(info) {
          selectedDate = info.dateStr;
          document.getElementById('bdate').value = selectedDate;
          document.getElementById('displayDate').innerText = selectedDate;
          document.getElementById('form').style.display = 'block';
          document.getElementById('bookingsContainer').style.display = 'none';
        },
        events: function(fetchInfo, successCallback) {
          axios.get('/api/bookings').then(res => {
            const events = res.data.map(ev => ({
              ...ev,
              display: 'background',
              backgroundColor: 'green',
              allDay: true
            }));
            successCallback(events);
          });
        }
      });
      calendar.render();

      // Показати список бронювань
      document.getElementById('viewBookingsBtn').addEventListener('click', function() {
        axios.get('/api/bookings_full').then(res => {
          let html = '<h3>Активні бронювання</h3><ul>';
          res.data.forEach(b => {
            html += `<li>${b.date} ${b.time} — ${b.name} (${b.contact})</li>`;
          });
          html += '</ul>';
          const container = document.getElementById('bookingsContainer');
          container.innerHTML = html;
          container.style.display = 'block';
          document.getElementById('form').style.display = 'none';
        });
      });

      // Обробка форми бронювання
      document.getElementById('bookingForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const start = document.getElementById('btime_start').value;
        const end   = document.getElementById('btime_end').value;
        const payload = {
          date: document.getElementById('bdate').value,
          time: `${start}–${end}`,
          name: document.getElementById('bname').value,
          contact: document.getElementById('bcontact').value
        };
        axios.post('/book', payload)
          .then(() => {
            window.location.href = '/export_ics'
              + '?date='    + encodeURIComponent(payload.date)
              + '&time='    + encodeURIComponent(payload.time)
              + '&name='    + encodeURIComponent(payload.name)
              + '&contact=' + encodeURIComponent(payload.contact);
          })
          .catch(() => { alert('Цей слот вже зайнятий'); });
      });

      document.getElementById('cancelBtn').addEventListener('click', function() {
        document.getElementById('form').style.display = 'none';
      });
    });
  </script>
</body>
</html>
